var t=function(){function t(){}var e;return Object.defineProperty(t,"APP",{get:function(){return this._store.APP},enumerable:!1,configurable:!0}),Object.defineProperty(t,"MODULE",{get:function(){return this._store.MODULE},enumerable:!1,configurable:!0}),Object.defineProperty(t,"ACCESS_KEY",{get:function(){return this._store.ACCESS_KEY},enumerable:!1,configurable:!0}),Object.defineProperty(t,"SECRET_KEY",{get:function(){return this._store.SECRET_KEY},enumerable:!1,configurable:!0}),e=t,t._store={APP:"",MODULE:"",ACCESS_KEY:"",SECRET_KEY:""},t.update=function(t){void 0===t&&(t={}),t.hasOwnProperty("APP")&&(e._store.APP=t.APP),t.hasOwnProperty("MODULE")&&(e._store.MODULE=t.MODULE),t.hasOwnProperty("ACCESS_KEY")&&(e._store.ACCESS_KEY=t.ACCESS_KEY),t.hasOwnProperty("SECRET_KEY")&&(e._store.SECRET_KEY=t.SECRET_KEY)},t}(),e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},e(t,n)};function n(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var r=function(){return r=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},r.apply(this,arguments)};function o(t,e,n,r){return new(n||(n=Promise))((function(o,i){function s(t){try{c(r.next(t))}catch(t){i(t)}}function a(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((r=r.apply(t,e||[])).next())}))}function i(t,e){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,a[0]&&(s=0)),s;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,r=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=e.call(t,s)}catch(t){a=[6,t],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}function s(t,e,n){if(n||2===arguments.length)for(var r,o=0,i=e.length;o<i;o++)!r&&o in e||(r||(r=Array.prototype.slice.call(e,0,o)),r[o]=e[o]);return t.concat(r||Array.prototype.slice.call(e))}var a={request:null,response:null},c=function(t,e){return void 0===e&&(e={}),o(void 0,void 0,void 0,(function(){var n,o;return i(this,(function(i){switch(i.label){case 0:return e=r({method:"GET"},e),a.request?[4,a.request(e)]:[3,2];case 1:e=i.sent(),i.label=2;case 2:return[4,fetch("".concat(t),e)];case 3:return n=i.sent(),a.response?[4,a.response({response:n})]:[3,5];case 4:i.sent(),i.label=5;case 5:return[4,n.json()];case 6:return o=i.sent(),[2,{response:n,data:o}]}}))}))},u=function(t,e,n){return void 0===n&&(n={}),o(void 0,void 0,void 0,(function(){var o,s,c,u;return i(this,(function(i){switch(i.label){case 0:return o=e instanceof FormData,s={},n.headers&&(s=n.headers),o||(s["Content-Type"]="application/x-www-form-urlencoded"),n=r({method:"POST",headers:s,body:o?e:Object.keys(e).map((function(t){var n=e[t];return"string"!=typeof n&&(n=JSON.stringify(e[t])),"".concat(encodeURIComponent(t),"=").concat(encodeURIComponent(n))})).join("&")},n),a.request?[4,a.request(n)]:[3,2];case 1:n=i.sent(),i.label=2;case 2:return[4,fetch("".concat(t),n)];case 3:return c=i.sent(),a.response?[4,a.response({response:c})]:[3,5];case 4:i.sent(),i.label=5;case 5:return[4,c.json()];case 6:return u=i.sent(),[2,{response:c,data:u}]}}))}))},h=function(t){function e(e){return t.call(this,e)||this}return n(e,t),e}(function(t){function e(e){var n=t.call(this,e)||this;return n.name=n.constructor.name,n}return n(e,t),e}(Error)),l={isEnabled:!1,token:""};a.request=function(e){return o(void 0,void 0,void 0,(function(){var n;return i(this,(function(o){switch(o.label){case 0:return t.ACCESS_KEY&&t.SECRET_KEY&&(e.headers||(e.headers={}),e.headers=r(r({},e.headers),{authorization:"Basic ".concat(btoa("".concat(t.ACCESS_KEY,":").concat(t.SECRET_KEY)))})),l.isEnabled?"POST"!==e.method?[3,3]:l.token?[3,2]:[4,c("".concat(t.MODULE,"/api/config/fetchCsrf"),{headers:{"X-CSRF-Token":"fetch"}})]:[3,3];case 1:n=o.sent().response,l.token=n.headers.get("X-CSRF-Token")||n.headers.get("x-csrf-token")||"",o.label=2;case 2:e.headers&&(e.headers=r(r({},e.headers),{"X-CSRF-Token":l.token})),o.label=3;case 3:return[2,e]}}))}))},a.response=function(t){var e=t.response;return o(void 0,void 0,void 0,(function(){return i(this,(function(t){if(302===e.status)throw new h("Unauthorized");return[2]}))}))};var d=function(){return o(void 0,void 0,void 0,(function(){var e,n;return i(this,(function(r){switch(r.label){case 0:return[4,c("".concat(t.MODULE,"/api/config"))];case 1:return(e=r.sent()).data&&e.data.csrf&&(n=e.data["X-CSRF-Token"],l.isEnabled=!0,l.token=n),[2,e.data]}}))}))},p=function(e,n){return o(void 0,void 0,void 0,(function(){var r,o,s,a,c,h,l;return i(this,(function(i){switch(i.label){case 0:if(!e)throw new Error("Missing Pixel");return r={expression:e},n&&(r.insightId=n),[4,u("".concat(t.MODULE,"/api/engine/runPixel"),r,{})];case 1:for(o=i.sent(),s=[],a=0,c=o.data.pixelReturn;a<c.length;a++)h=c[a],l=h.output,h.operationType.indexOf("ERROR")>-1&&s.push(l);return[2,{errors:s,insightId:o.data.insightID,pixelReturn:o.data.pixelReturn}]}}))}))},f=function(e,n){return o(void 0,void 0,void 0,(function(){var r,o,s,a,c;return i(this,(function(i){switch(i.label){case 0:if(!e)throw Error("No Pixel To Execute");r="",r+="expression="+encodeURIComponent(e),n&&(r+="&insightId="+encodeURIComponent(n)),i.label=1;case 1:return i.trys.push([1,6,,7]),[4,fetch("".concat(t.MODULE,"/api/engine/runPixelAsync"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r})];case 2:return(o=i.sent()).ok?[3,4]:[4,o.json()];case 3:throw s=i.sent(),Error(s.errorMessage||"Failed to run pixel");case 4:return[4,o.json()];case 5:if(!(a=i.sent()))throw Error("No Pixel Response");return[2,{jobId:a.jobId}];case 6:if((c=i.sent())instanceof Error)throw c;throw Error("An unknown error occurred");case 7:return[2]}}))}))},v=function(e){return o(void 0,void 0,void 0,(function(){var n,r,o,s,a,c,u,h,l,d;return i(this,(function(i){switch(i.label){case 0:if(!e)throw Error("No job id provided to get pixel response");(n=new URLSearchParams).append("jobId",e),i.label=1;case 1:return i.trys.push([1,6,,7]),[4,fetch("".concat(t.MODULE,"/api/engine/result"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n})];case 2:return(r=i.sent()).ok?[3,4]:[4,r.json()];case 3:throw o=i.sent(),Error(o.errorMessage||"Failed to get pixel response");case 4:return[4,r.json()];case 5:if(!(s=i.sent()))throw Error("No Pixel Response");for(a=[],c=0,u=s.pixelReturn;c<u.length;c++)h=u[c],l=h.output,h.operationType.indexOf("ERROR")>-1&&a.push(l);return[2,{errors:a,insightId:s.insightID,results:s.pixelReturn}];case 6:if((d=i.sent())instanceof Error)throw d;throw Error("An unknown error occurred");case 7:return[2]}}))}))},y=function(e,n){return o(void 0,void 0,void 0,(function(){return i(this,(function(r){switch(r.label){case 0:return[4,u("".concat(t.MODULE,"/api/auth/login"),{username:e,password:n,disableRedirect:!0})];case 1:return r.sent(),[2,!0]}}))}))},b=function(e,n){return void 0===n&&(n=!1),o(void 0,void 0,void 0,(function(){var r;return i(this,(function(s){switch(s.label){case 0:return[4,c("".concat(t.MODULE,"/api/auth/userinfo/").concat(e))];case 1:if((r=s.sent()).data&&r.data.name)return[2,!0];if(n)throw new Error("Unable to login");return[2,new Promise((function(n,r){if(window&&window.top)var s="".concat(t.MODULE,"/api/auth/login/").concat(e),a=window.top.open(s,"_blank","height=600,width=400,top=300,left=600"),c=setInterval((function(){return o(void 0,void 0,void 0,(function(){var t;return i(this,(function(r){switch(r.label){case 0:return r.trys.push([0,4,,5]),a&&!a.closed&&void 0!==a.closed?[3,1]:(clearInterval(c),[3,3]);case 1:return a.document.location.href.indexOf("".concat(window.location.host))>-1?(clearInterval(c),a.close(),[4,b(e,!0)]):[3,3];case 2:t=r.sent(),n(t),r.label=3;case 3:return[3,5];case 4:return r.sent(),[3,5];case 5:return[2]}}))}))}),1e3);else r("Unable to login")}))]}}))}))},w=function(){return o(void 0,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,c("".concat(t.MODULE,"/api/auth/logout/all"))];case 1:return e.sent(),[2,!0]}}))}))},g=function(e,n,r,s){return o(void 0,void 0,void 0,(function(){var o,a,c,h;return i(this,(function(i){switch(i.label){case 0:if(o="",s=s||"",(n||r||s)&&(n&&(o.length>0&&(o+="&"),o+="insightId=".concat(n)),r&&(o.length>0&&(o+="&"),o+="projectId=".concat(r)),s&&(o.length>0&&(o+="&"),o+="path=".concat(s)),o="?".concat(o)),a="".concat(t.MODULE,"/api/uploadFile/baseUpload").concat(o),c=new FormData,Array.isArray(e))for(h=0;h<e.length;h++)c.append("file",e[h]);else c.append("file",e);return[4,u(a,c,{})];case 1:return[2,i.sent().data]}}))}))},E=function(e,n){return o(void 0,void 0,void 0,(function(){return i(this,(function(r){return[2,new Promise((function(r){if(!e)throw Error("No Insight ID provided for download.");var o="".concat(t.MODULE,"/api/engine/downloadFile?insightId=").concat(e,"&fileKey=").concat(encodeURIComponent(n)),i=document.createElement("a");i.href=o,i.target="_blank",document.body.appendChild(i),i.click(),document.body.removeChild(i),r()}))]}))}))},_=function(e){return o(void 0,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return[4,u("".concat(t.MODULE,"/api/engine/partial"),{jobId:e})];case 1:return[2,n.sent().data]}}))}))},m=function(e){return o(void 0,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return[4,u("".concat(t.MODULE,"/api/engine/console"),{jobId:e})];case 1:return[2,n.sent().data]}}))}))},I=function(e){return o(void 0,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return[4,u("".concat(t.MODULE,"/api/engine/console"),{jobId:e})];case 1:return[2,n.sent().data]}}))}))},O=function(){function e(){var e=this;this._store={insightId:"",isInitialized:!1,isAuthorized:!1,isReady:!1,error:null,system:null,options:{appId:"",python:null}},this.initialize=function(n){return o(e,void 0,void 0,(function(){var e,r,o,s,a,c;return i(this,(function(i){switch(i.label){case 0:return this._store.isInitialized=!1,this._store.isAuthorized=!1,this._store.isReady=!1,e={app:n&&n.app?n.app:"",python:n&&void 0!==n.python?n.python:{type:"detect"}},this._store.options.appId="",e.app&&(this._store.options.appId=e.app),this._store.options.python=null,e.python?"detect"!==e.python.type?[3,2]:(r=this._store.options,[4,this.detectScript()]):[3,5];case 1:return r.python=i.sent(),[3,5];case 2:return"file"!==e.python.type?[3,4]:(o=this._store.options,[4,this.loadScript(e.python)]);case 3:return o.python=i.sent(),[3,5];case 4:"script"===e.python.type&&(this._store.options.python={script:e.python.script,alias:e.python.alias}),i.label=5;case 5:try{if(!document)return[2];(s=JSON.parse((null===(c=document.getElementById("semoss-env"))||void 0===c?void 0:c.textContent)||""))&&t.update({APP:s.APP,MODULE:s.MODULE})}catch(t){}i.label=6;case 6:if(i.trys.push([6,11,,12]),t.APP&&(this._store.options.appId=t.APP),!t.MODULE)throw new Error("module is required");return[4,this.setupSystem()];case 7:if(i.sent(),!this._store.isInitialized)throw new Error("Error loading system");return this._store.system&&Object.keys(this._store.system.config.logins).length>0||t.ACCESS_KEY&&t.SECRET_KEY?(this._store.isAuthorized=!0,[4,this.setupInsight()]):[3,9];case 8:return i.sent(),[3,10];case 9:this._store.isAuthorized=!1,i.label=10;case 10:return[3,12];case 11:return a=i.sent(),console.warn(a),this._store.error=a,[3,12];case 12:return[2]}}))}))},this.destroy=function(){return o(e,void 0,void 0,(function(){var t;return i(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,3,4]),[4,this.destroyInsight()];case 1:return e.sent(),this.destroySystem(),[3,4];case 2:return t=e.sent(),console.warn(t),this._store.error=t,[3,4];case 3:return this._store.isInitialized=!1,this._store.isAuthorized=!1,this._store.isReady=!1,[7];case 4:return[2]}}))}))},this.setupSystem=function(){return o(e,void 0,void 0,(function(){var t,e,n;return i(this,(function(r){switch(r.label){case 0:return this._store.isInitialized=!1,[4,d()];case 1:if(t=r.sent(),e=null,t)for(n in e={config:{logins:{},availableProviders:[]}},t)e.config[n]=t[n];return this._store.system=e,this._store.system?this._store.isInitialized=!0:this._store.isInitialized=!1,[2]}}))}))},this.destroySystem=function(){e._store.system=null},this.setupInsight=function(){return o(e,void 0,void 0,(function(){var t,e,n,r,o;return i(this,(function(i){switch(i.label){case 0:return this._store.isReady=!1,t="",this._store.options.appId&&(t+='SetContext("'.concat(this._store.options.appId,'");')),this._store.options.python&&this._store.options.python.script&&((e=this._store.options.python.alias)||(e="smss",console.warn("Alias not found. Loading python as ".concat(e))),t+='\nWriteObjectToFile(value="'.concat(this._store.options.python.script,'", filePath = "temp.py");\nLoadPyFromFile(alias="').concat(e,'", filePath="temp.py");    \n            ')),t||(t="1+1;"),[4,p(t,"new")];case 1:if(n=i.sent(),r=n.insightId,(o=n.errors).length)throw new Error(o[0]);return this._store.insightId=r,this._store.isReady=!0,[2]}}))}))},this.destroyInsight=function(){return o(e,void 0,void 0,(function(){var t;return i(this,(function(e){switch(e.label){case 0:return this._store.insightId?[4,p("DropInsight()",this._store.insightId)]:[2];case 1:if((t=e.sent().errors).length)throw new Error(t[0]);return this._store.insightId="",[2]}}))}))},this.processActionError=function(t){if(!(t instanceof h))throw t;e._store.isAuthorized=!1},this.detectScript=function(){return o(e,void 0,void 0,(function(){var t,e,n;return i(this,(function(r){t={script:"",alias:""};try{if(e=document.querySelector("[data-semoss-py]"),!(n=null==e?void 0:e.textContent))return[2,null];t.script=n,t.alias=(null==e?void 0:e.getAttribute("data-alias"))||""}catch(t){return console.warn(t),[2,null]}return[2,t]}))}))},this.loadScript=function(t){return o(e,void 0,void 0,(function(){var e,n,r;return i(this,(function(o){switch(o.label){case 0:e={script:"",alias:t.alias},o.label=1;case 1:return o.trys.push([1,4,,5]),[4,fetch(t.path)];case 2:return[4,o.sent().text()];case 3:if(!(n=o.sent()))throw new Error("No Text");return e.script=n,[3,5];case 4:return r=o.sent(),console.warn(r),[2,null];case 5:return[2,e]}}))}))},this.actions={login:function(t){return o(e,void 0,void 0,(function(){var e,n;return i(this,(function(r){switch(r.label){case 0:return r.trys.push([0,8,,9]),e=!1,"native"!==t.type?[3,2]:[4,y(t.username,t.password)];case 1:return r.sent()&&(e=!0),[3,4];case 2:return"oauth"!==t.type?[3,4]:[4,b(t.provider)];case 3:r.sent()&&(e=!0),r.label=4;case 4:return e?(this._store.isAuthorized=!0,[4,this.setupInsight()]):[3,6];case 5:return r.sent(),[3,7];case 6:this._store.isAuthorized=!1,r.label=7;case 7:return[2,e];case 8:return n=r.sent(),this.processActionError(n),[3,9];case 9:return[2,!1]}}))}))},logout:function(){return o(e,void 0,void 0,(function(){var t;return i(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,w()];case 1:return e.sent()?[2,!0]:[2,!1];case 2:return t=e.sent(),this.processActionError(t),[3,3];case 3:return[2,!1]}}))}))},run:function(t,n){return void 0===n&&(n="insight"),o(e,void 0,void 0,(function(){var e,r,o,s,a;return i(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,2,,3]),e="","insight"===n)e=this._store.insightId;else if("app"===n){if(!this._store.options.appId)throw new Error("An app is required to run in the app space");e=this._store.options.appId}return[4,p(t,e)];case 1:if(r=i.sent(),o=r.errors,s=r.pixelReturn,o.length)throw new Error(o.join(""));return[2,{pixelReturn:s}];case 2:return a=i.sent(),this.processActionError(a),[3,3];case 3:throw new Error("No response")}}))}))},runPy:function(t,n){return void 0===n&&(n="insight"),o(e,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,this.actions.run('Py("<encode>'.concat(t,'</encode>")'),n)];case 1:return[2,{output:e.sent().pixelReturn[0].output[0].output}]}}))}))},askModel:function(t,n,r){return void 0===r&&(r="insight"),o(e,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,this.actions.run('LLM(engine=["'.concat(t,'"], command=["<encode>').concat(n,'</encode>"]);'),r)];case 1:return[2,{output:e.sent().pixelReturn[0].output}]}}))}))},queryDatabase:function(t,n,r,s){return void 0===r&&(r={collect:-1}),void 0===s&&(s="insight"),o(e,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,this.actions.run('Database(database=["'.concat(t,'"]) | Query("<encode>').concat(n,'</encode>") | Collect(').concat("number"==typeof r.collect?r.collect:-1,");;"),s)];case 1:return[2,{output:e.sent().pixelReturn[0].output}]}}))}))},upload:function(t,n,r){return void 0===r&&(r="insight"),o(e,void 0,void 0,(function(){var e;return i(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,g(t,this._store.insightId,"app"===r?this._store.options.appId:"",n)];case 1:return[2,o.sent()];case 2:return e=o.sent(),this.processActionError(e),[3,3];case 3:throw new Error("No upload")}}))}))},download:function(t,n){return void 0===n&&(n="insight"),o(e,void 0,void 0,(function(){var e,r,o,s;return i(this,(function(i){switch(i.label){case 0:return e=this.getSpaceId(n),[4,this.actions.run('DownloadAsset(filePath=["'.concat(t,'"], space=["').concat(e,'"]);'),"insight")];case 1:r=i.sent().pixelReturn,o=r[0].output,i.label=2;case 2:return i.trys.push([2,4,,5]),[4,E(this._store.insightId,o)];case 3:return i.sent(),[2,!0];case 4:return s=i.sent(),this.processActionError(s),[3,5];case 5:throw new Error("No download")}}))}))}}}return Object.defineProperty(e.prototype,"insightId",{get:function(){return this._store.insightId},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isInitialized",{get:function(){return this._store.isInitialized},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isAuthorized",{get:function(){return this._store.isAuthorized},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isReady",{get:function(){return this._store.isReady},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"error",{get:function(){return this._store.error},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"system",{get:function(){return this._store.system},enumerable:!1,configurable:!0}),e.prototype.getSpaceId=function(t){var e="";if("insight"===t)e=this._store.insightId;else if("app"===t){if(!this._store.options.appId)throw new Error("An app is required to run in the app space");e=this._store.options.appId}return e},e}();export{t as E,O as I,h as U,o as _,d as a,f as b,v as c,w as d,E as e,_ as f,c as g,m as h,a as i,I as j,i as k,y as l,s as m,r as n,b as o,u as p,p as r,g as u};
//# sourceMappingURL=insight.store-1d26f990.js.map
